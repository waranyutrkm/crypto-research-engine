<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Research Engine v3.5.2 Re-Based (Thai Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');

        body { font-family: 'Noto Sans Thai', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #111827; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(75, 85, 99, 0.4);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        /* Input Styles */
        .opt-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            outline: none;
            transition: all 0.2s;
            color: #fbbf24;
            text-align: center;
            width: 100%;
        }
        .opt-input:focus { border-color: #f59e0b; background: rgba(0,0,0,0.5); }
        .opt-input:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Range Group */
        .range-group { display: flex; gap: 4px; align-items: center; }
        .range-sep { font-size: 9px; color: #6b7280; font-weight: bold; }

        /* Tooltip Styles */
        .has-tooltip { position: relative; cursor: help; margin-left: 4px; color: #6b7280; transition: color 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .has-tooltip:hover { color: #f59e0b; }
        
        .tooltip-content {
            visibility: hidden; position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%);
            width: 320px; background-color: #1f2937; color: #d1d5db; text-align: left;
            border-radius: 8px; padding: 12px; opacity: 0; transition: opacity 0.2s;
            border: 1px solid #374151; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.9);
            pointer-events: none; font-size: 11px; line-height: 1.5;
            z-index: 9999; 
        }
        .has-tooltip:hover .tooltip-content { visibility: visible; opacity: 1; }
        .tooltip-title { color: #f59e0b; font-weight: bold; font-size: 12px; margin-bottom: 6px; display: block; border-bottom: 1px solid #374151; padding-bottom: 4px; }
        .tooltip-formula { background: rgba(0,0,0,0.3); padding: 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; margin: 6px 0; display: block; color: #60a5fa; text-align: center; border: 1px dashed #374151; }
        .tooltip-ex { color: #9ca3af; font-style: italic; border-left: 3px solid #374151; padding-left: 8px; margin-top: 6px; display: block; background: rgba(255,255,255,0.02); padding: 4px 8px; border-radius: 0 4px 4px 0; }

        /* Log Table */
        .log-table { width: 100%; min-width: 800px; }
        .log-table td, .log-table th { padding: 8px 12px; font-size: 11px; font-family: 'JetBrains Mono', monospace; border-bottom: 1px solid #374151; vertical-align: middle; white-space: nowrap; }
        .log-table th { text-transform: uppercase; color: #9ca3af; text-align: left; background: #111827; position: sticky; top: 0; z-index: 20; box-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .log-buy { color: #4ade80; font-weight: bold; }
        .log-sell { color: #f87171; font-weight: bold; }
        .log-alloc { color: #9ca3af; font-size: 10px; line-height: 1.4; white-space: normal; min-width: 200px; }
        .alloc-tag { display: inline-block; background: rgba(255,255,255,0.08); padding: 2px 5px; border-radius: 3px; margin: 1px; border: 1px solid rgba(255,255,255,0.05); }

        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .tab-active { border-color: #f59e0b; color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .tab-inactive { color: #9ca3af; hover:text-gray-200; }
        
        .metric-card { background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 6px; padding: 6px 8px; text-align: center; }
        .metric-val { font-family: 'JetBrains Mono', monospace; font-weight: bold; font-size: 13px; }
        .metric-label { font-size: 9px; color: #9ca3af; text-transform: uppercase; margin-top: 2px; font-weight: bold; }
        .bench-val { font-size: 8px; color: #6b7280; margin-top: 2px; font-family: 'JetBrains Mono', monospace; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 2px; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 6px; width: 100%; }
        
        .metric-pos { color: #4ade80; }
        .metric-neg { color: #f87171; }
        .metric-neu { color: #fbbf24; }
        .metric-vol { color: #60a5fa; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #111827; border: 1px solid #374151; border-radius: 16px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; padding: 24px; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        /* Infographic Steps */
        .info-step { display: flex; align-items: flex-start; margin-bottom: 24px; position: relative; }
        .info-step:last-child { margin-bottom: 0; }
        .info-step::after { content: ''; position: absolute; left: 24px; top: 50px; bottom: -24px; width: 2px; background: #374151; z-index: 0; }
        .info-step:last-child::after { display: none; }
        .step-icon { width: 50px; height: 50px; background: #1f2937; border: 2px solid #f59e0b; color: #f59e0b; rounded-full; display: flex; align-items: center; justify-content: center; font-size: 20px; border-radius: 50%; z-index: 10; flex-shrink: 0; margin-right: 20px; box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
        .step-content { background: rgba(31, 41, 55, 0.5); border: 1px solid #374151; border-radius: 8px; padding: 16px; flex-grow: 1; }
        
        .strat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; margin-top: 10px; }
        .strat-card { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; font-size: 11px; }
        .strat-name { color: #60a5fa; font-weight: bold; margin-bottom: 4px; font-size: 12px; }
        .strat-formula { background: rgba(0,0,0,0.3); padding: 4px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; color: #fbbf24; margin-bottom: 4px; display: block; }
        .strat-ex { color: #9ca3af; font-style: italic; border-left: 2px solid #4b5563; padding-left: 6px; }
        
        /* Pagination */
        .pagination-btn { background: #374151; color: #d1d5db; border: 1px solid #4b5563; padding: 4px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        .pagination-btn:hover:not(:disabled) { background: #f59e0b; color: #111827; border-color: #f59e0b; transform: translateY(-1px); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 border-b border-gray-700 p-3 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded flex items-center justify-center text-gray-900 font-bold text-lg shadow">B</div>
                <h1 class="text-lg font-bold text-gray-100 tracking-wider">
                    BINANCE <span class="text-xs bg-gray-700 text-yellow-500 px-2 py-0.5 rounded ml-2 border border-yellow-500/20">RESEARCH ENGINE v3.5.2 Re-Based</span>
                </h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="dateRangeDisplay" class="text-xs font-mono text-yellow-500 font-bold hidden md:inline">Waiting for Data...</span>
                <button onclick="toggleModal('infoModal')" class="bg-gray-700 hover:bg-gray-600 text-xs px-3 py-1.5 rounded transition flex items-center gap-2 border border-gray-600 shadow-sm">
                    <i class="fas fa-project-diagram text-yellow-500"></i> System Workflow
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow flex flex-col gap-4">

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 h-full">
            
            <div class="lg:col-span-3 space-y-4 flex flex-col">
                <div class="glass-panel p-4 rounded-xl flex-grow">
                    <div class="flex items-center justify-between mb-4 border-b border-gray-700 pb-2">
                        <h2 class="text-xs font-bold text-gray-300 uppercase"><i class="fas fa-sliders-h mr-2"></i> Configuration</h2>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Candidate Pool</label>
                            <button onclick="autoScanMarket()" id="btnScan" class="text-[9px] bg-purple-600 hover:bg-purple-500 text-white px-2 py-0.5 rounded transition border border-purple-400 shadow-sm flex items-center gap-1">
                                <i class="fas fa-satellite-dish"></i> Scan Top 50 Liquid Pairs
                            </button>
                        </div>
                        <textarea id="universeInput" rows="3"
                               class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1.5 text-xs text-yellow-400 font-mono focus:outline-none focus:border-yellow-500 uppercase mb-2 custom-scroll resize-none placeholder-gray-600"
                               placeholder="Click 'Scan' or 'Run' (Auto-Fill)..."
                               ></textarea>
                        
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500 uppercase font-bold">Bench:</span>
                            <input type="text" id="benchmarkInput" value="BTC" class="bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-blue-400 font-mono focus:outline-none focus:border-blue-500 w-20 text-center uppercase">
                        </div>
                    </div>

                    <div class="space-y-3 mb-4 border-t border-gray-700 pt-3">
                        <!-- NEW: Liquidity Grid Section -->
                        <div class="bg-blue-900/20 p-2 rounded border border-blue-500/20">
                            <div class="flex items-center justify-between mb-1">
                                <label class="text-[10px] text-blue-300 font-bold uppercase">Universe Size (Grid)</label>
                                <i class="fas fa-question-circle has-tooltip">
                                    <div class="tooltip-content">
                                        <span class="tooltip-title">Liquidity Grid (ขนาดพอร์ต)</span>
                                        ระบบจะทดสอบขนาดของพอร์ตที่ต่างกัน โดยคัดเลือกจาก Dollar Volume (30D Avg) จาก Candidate Pool ที่สแกนมา
                                        <span class="tooltip-ex">Start: 5, End: 15, Step: 5 <br>-> ทดสอบพอร์ตที่มี Top 5, Top 10, และ Top 15 เหรียญสภาพคล่องสูงสุด</span>
                                    </div>
                                </i>
                            </div>
                            <div class="range-group">
                                <input id="univStart" type="number" value="5" class="opt-input text-blue-200" placeholder="Start">
                                <span class="range-sep text-blue-400">~</span>
                                <input id="univEnd" type="number" value="15" class="opt-input text-blue-200" placeholder="End">
                                <span class="range-sep text-blue-400">+</span>
                                <input id="univStep" type="number" value="5" class="opt-input text-blue-200" placeholder="Step">
                            </div>
                            <div class="flex items-center justify-between mt-2">
                                <label class="text-[9px] text-gray-500 uppercase">Univ. Update (Days):</label>
                                <input id="univRebalDays" type="number" value="30" class="bg-gray-800 border border-gray-600 rounded px-2 py-0.5 text-[10px] text-blue-200 text-center w-12" title="Freeze universe for N days">
                            </div>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label class="text-[10px] text-gray-400 font-bold uppercase">Strategy Rebal (Days)</label>
                                <i class="fas fa-question-circle has-tooltip">
                                    <div class="tooltip-content">
                                        <span class="tooltip-title">Rebalance Frequency</span>
                                        ความถี่ในการปรับน้ำหนัก (Weight) ภายใน Universe เดิม
                                        <span class="tooltip-ex">Ex: 7 วันปรับน้ำหนักทีนึง แต่ Universe จะเปลี่ยนคนเล่นใหม่ทุก 30 วัน (ตามค่า Univ. Update)</span>
                                    </div>
                                </i>
                            </div>
                            <div class="range-group">
                                <input id="rbStart" type="number" value="7" class="opt-input" placeholder="Start">
                                <span class="range-sep">~</span>
                                <input id="rbEnd" type="number" value="14" class="opt-input" placeholder="End">
                                <span class="range-sep">+</span>
                                <input id="rbStep" type="number" value="7" class="opt-input" placeholder="Step">
                            </div>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label class="text-[10px] text-gray-400 font-bold uppercase">Lookback (Days)</label>
                            </div>
                            <div class="range-group">
                                <input id="lbStart" type="number" value="14" class="opt-input" placeholder="Start">
                                <span class="range-sep">~</span>
                                <input id="lbEnd" type="number" value="30" class="opt-input" placeholder="End">
                                <span class="range-sep">+</span>
                                <input id="lbStep" type="number" value="16" class="opt-input" placeholder="Step">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div>
                            <label class="block text-[10px] text-gray-400 font-bold uppercase mb-1">Initial ($)</label>
                            <input type="number" id="capital" value="10000" class="opt-input">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 font-bold uppercase mb-1">Fee (%)</label>
                            <input type="number" id="fee" value="0.1" step="0.01" class="opt-input">
                        </div>
                    </div>

                    <button id="fetchBtn" onclick="runPipeline()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-2.5 px-4 rounded text-xs uppercase tracking-wider transition shadow-lg transform hover:scale-[1.02] mb-3">
                        <i class="fas fa-play mr-1"></i> Run Liquid Grid
                    </button>

                    <div>
                        <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                            <span>Progress</span>
                            <span id="simCount">0/0</span>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-1.5 mb-2 overflow-hidden">
                            <div id="progressBar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div id="statusBox" class="text-[9px] font-mono text-gray-400 h-20 overflow-y-auto custom-scroll bg-black/30 p-1.5 rounded border border-gray-700/50">
                            > Press 'Scan' or 'Run' to start.
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-9 flex flex-col gap-4">
                
                <div class="glass-panel rounded-xl overflow-hidden flex flex-col h-[600px] relative">
                    <div class="flex border-b border-gray-700 bg-gray-800/50">
                        <button onclick="setTab('chart')" id="tab-chart" class="flex-1 py-2.5 text-xs font-bold uppercase tracking-wide tab-btn tab-active"><i class="fas fa-chart-area mr-1"></i> Equity</button>
                        <button onclick="setTab('landscape')" id="tab-landscape" class="flex-1 py-2.5 text-xs font-bold uppercase tracking-wide tab-btn tab-inactive"><i class="fas fa-cubes mr-1"></i> 3D Grid</button>
                        <button onclick="setTab('dist')" id="tab-dist" class="flex-1 py-2.5 text-xs font-bold uppercase tracking-wide tab-btn tab-inactive"><i class="fas fa-chart-bar mr-1"></i> Risk Profile</button>
                        <button onclick="setTab('monte')" id="tab-monte" class="flex-1 py-2.5 text-xs font-bold uppercase tracking-wide tab-btn tab-inactive"><i class="fas fa-random mr-1"></i> Monte Carlo</button>
                        <button onclick="setTab('logs')" id="tab-logs" class="flex-1 py-2.5 text-xs font-bold uppercase tracking-wide tab-btn tab-inactive"><i class="fas fa-list-ul mr-1"></i> Logs</button>
                    </div>

                    <div class="p-1 flex-grow relative bg-gray-900/50">
                        
                        <div id="panel-chart" class="h-full w-full flex flex-col p-3">
                            <div class="flex flex-col gap-2 mb-2">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <h3 class="text-xs text-yellow-500 font-bold uppercase">Performance Metrics</h3>
                                    </div>
                                    <div id="chartLabel" class="text-[10px] text-gray-400 font-mono">Select a strategy below</div>
                                </div>
                                <div class="metric-grid" id="kpiBar">
                                    <div class="metric-card"><div class="metric-val text-gray-500">-</div><div class="metric-label">Sharpe</div></div>
                                    <div class="metric-card"><div class="metric-val text-gray-500">-</div><div class="metric-label">Win30d</div></div>
                                    <div class="metric-card"><div class="metric-val text-gray-500">-</div><div class="metric-label">CAGR</div></div>
                                    <div class="metric-card"><div class="metric-val text-gray-500">-</div><div class="metric-label">MaxDD</div></div>
                                    <div class="metric-card"><div class="metric-val text-gray-500">-</div><div class="metric-label">Vol</div></div>
                                    <div class="metric-card"><div class="metric-val text-gray-500">-</div><div class="metric-label">Univ.Size</div></div>
                                    <div class="metric-card"><div class="metric-val text-gray-500">-</div><div class="metric-label">Worst M</div></div>
                                </div>
                            </div>
                            <div class="flex-grow flex flex-col gap-2">
                                <div class="relative h-2/3 bg-black/20 rounded border border-gray-700/30 p-2">
                                    <canvas id="equityChart"></canvas>
                                </div>
                                <div class="relative h-1/3 bg-black/20 rounded border border-gray-700/30 p-2">
                                    <canvas id="drawdownChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div id="panel-landscape" class="h-full w-full hidden flex flex-col p-3">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-xs text-purple-400 font-bold uppercase">3D Parameter Landscape</h3>
                                </div>
                                <select id="landscapeMetric" onchange="renderLandscape()" class="bg-gray-800 text-[10px] text-white border border-gray-600 rounded px-2 py-1 cursor-pointer">
                                    <option value="Sharpe">Metric: Sharpe</option>
                                    <option value="Win30d">Metric: Win30d %</option>
                                    <option value="CAGR">Metric: CAGR</option>
                                    <option value="MaxDD">Metric: Drawdown</option>
                                    <option value="RobustScore">Metric: Robust Score</option>
                                </select>
                            </div>
                            <div id="landscapeDiv" class="flex-grow w-full bg-black/20 rounded border border-gray-700/30"></div>
                        </div>

                        <div id="panel-dist" class="h-full w-full hidden flex flex-col p-3">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xs text-blue-400 font-bold uppercase">Risk Profile Distribution</h3>
                                <div class="flex items-center gap-2">
                                    <select id="distMetric" onchange="renderDistribution()" class="bg-gray-800 text-[10px] text-white border border-gray-600 rounded px-2 py-1 cursor-pointer">
                                        <option value="RobustScore">Dist: Robust Score</option>
                                        <option value="Sharpe">Dist: Sharpe Ratio</option>
                                        <option value="Win30d">Dist: Win30d %</option>
                                        <option value="CAGR">Dist: CAGR %</option>
                                    </select>
                                </div>
                            </div>
                            <div class="relative flex-grow bg-black/20 rounded border border-gray-700/30 p-2">
                                <canvas id="distChart"></canvas>
                            </div>
                        </div>

                        <div id="panel-monte" class="h-full w-full hidden flex flex-col p-3">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-4">
                                    <h3 class="text-xs text-pink-400 font-bold uppercase">Monte Carlo Forecast</h3>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] text-gray-400">Yrs:</span>
                                        <input id="monteYears" type="number" value="1" min="1" max="5" class="bg-gray-800 border border-gray-600 rounded px-2 py-0.5 text-xs text-center w-10 text-pink-400" onchange="rerunMonte()">
                                        <button onclick="rerunMonte()" class="text-gray-400 hover:text-white"><i class="fas fa-sync-alt text-xs"></i></button>
                                    </div>
                                </div>
                                <div id="monteStats" class="text-[10px] font-mono text-gray-300"></div>
                            </div>
                            <div id="monteDiv" class="flex-grow w-full bg-black/20 rounded border border-gray-700/30"></div>
                        </div>

                        <div id="panel-logs" class="h-full w-full hidden flex flex-col p-3">
                             <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xs text-green-400 font-bold uppercase">Transaction Logs (Universe Rebal)</h3>
                                <div class="flex items-center gap-4 text-[10px] text-gray-500 font-mono">
                                    <span id="logMeta" class="text-gray-400">No Data</span>
                                    <div class="flex gap-2 items-center">
                                        <button onclick="changeLogPage(-1)" id="btnPrevLog" class="pagination-btn" disabled><i class="fas fa-chevron-left mr-1"></i> Prev</button>
                                        <span id="logPageNum" class="text-white font-bold bg-gray-800 px-2 py-1 rounded min-w-[60px] text-center border border-gray-600">1 / 1</span>
                                        <button onclick="changeLogPage(1)" id="btnNextLog" class="pagination-btn" disabled>Next <i class="fas fa-chevron-right ml-1"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-auto custom-scroll flex-grow bg-black/20 rounded border border-gray-700/50 relative">
                                <table class="log-table border-collapse">
                                    <thead>
                                        <tr>
                                            <th class="w-24">Date</th>
                                            <th class="w-20">Event</th>
                                            <th>Universe / Allocation Change</th>
                                            <th class="text-right w-20">Fee</th>
                                            <th class="text-right w-24">NAV</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logBody" class="text-gray-300">
                                        <tr><td colspan="5" class="text-center text-gray-500 py-20 italic">Run simulation & click 'VIEW' to see logs.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-4 rounded-xl flex-grow overflow-hidden flex flex-col min-h-[300px]">
                    <div class="flex flex-wrap justify-between items-center mb-3 pb-2 border-b border-gray-700">
                        <h2 class="text-xs font-bold text-gray-300 uppercase"><i class="fas fa-trophy mr-2 text-yellow-500"></i> Leaderboard (Grid Result)</h2>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">Filter:</label>
                                <select id="strategyFilter" onchange="filterResults()" class="bg-gray-800 border border-gray-600 text-[10px] text-white rounded px-2 py-1 outline-none uppercase font-mono">
                                    <option value="ALL">Show All</option>
                                    <option value="Equal">Equal Weight</option>
                                    <option value="Rank">Rank Momentum</option>
                                    <option value="Top3">Top 3 Leader</option>
                                    <option value="Top50Rank">Top 50% Ranked</option>
                                    <option value="MomWeight">Momentum Weighted</option>
                                    <option value="InvVol">Inverse Vol</option>
                                    <option value="AAA">Adaptive Aggressive</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">Sort:</label>
                                <select id="sortMetric" onchange="sortResults()" class="bg-gray-800 border border-gray-600 text-[10px] text-white rounded px-2 py-1 outline-none font-mono">
                                    <option value="Sharpe">Sharpe</option>
                                    <option value="RobustScore">Robust Score</option>
                                    <option value="Win30d">Win 30d %</option>
                                    <option value="CAGR">CAGR</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-auto custom-scroll flex-grow">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-[10px] text-gray-400 uppercase border-b border-gray-600 sticky top-0 bg-gray-800 z-10 shadow-sm">
                                    <th class="p-3">Rank</th>
                                    <th class="p-3">Strategy</th>
                                    <th class="p-3 text-center">Univ. Size</th>
                                    <th class="p-3 text-center">LB / RB</th>
                                    <th class="p-3 text-right">CAGR</th>
                                    <th class="p-3 text-right text-yellow-500">Sharpe</th>
                                    <th class="p-3 text-right text-blue-400">Win30d</th>
                                    <th class="p-3 text-right text-green-400">R-Score</th>
                                    <th class="p-3 text-right text-red-400">MaxDD</th>
                                    <th class="p-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody" class="text-xs font-mono text-gray-300">
                                <tr><td colspan="10" class="p-8 text-center text-gray-500 italic">Scan Market & Run Liquid Grid...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Info Modal -->
        <div id="infoModal" class="modal-overlay" onclick="if(event.target === this) toggleModal('infoModal')">
            <div class="modal-content">
                <button onclick="toggleModal('infoModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
                <h2 class="text-2xl font-bold text-blue-400 mb-2 border-b border-gray-700 pb-4"><i class="fas fa-water mr-2"></i> Liquid Universe Logic</h2>
                <div class="mt-6 p-4">
                    <div class="info-step"><div class="step-icon"><i class="fas fa-satellite-dish"></i></div><div class="step-content"><h3 class="text-lg font-bold text-purple-400 mb-1">1. Market Scan</h3><p class="text-gray-400 text-sm">กดปุ่ม <strong>Scan Top 50</strong> เพื่อดึงข้อมูลจริงจาก Binance (24h Volume) ระบบจะตัด Stablecoin/Leverage Token ออกให้เหลือแต่เหรียญเทรดจริง</p></div></div>
                    <div class="info-step"><div class="step-icon"><i class="fas fa-layer-group"></i></div><div class="step-content"><h3 class="text-lg font-bold text-yellow-500 mb-1">2. Dollar Volume Engine</h3><p class="text-gray-400 text-sm">ระบบนำรายชื่อที่สแกนได้ไปดึงข้อมูลย้อนหลัง และคำนวณ <code>30-Day Avg Volume</code> เพื่อใช้เป็นเกณฑ์ตัดสินใจ</p></div></div>
                    <div class="info-step"><div class="step-icon"><i class="fas fa-filter"></i></div><div class="step-content"><h3 class="text-lg font-bold text-blue-400 mb-1">3. Dynamic Selection</h3><p class="text-gray-400 text-sm">ทุกๆ รอบ <strong>Universe Update Days</strong> ระบบจะจัดลำดับความสภาพคล่องใหม่ และคัดเลือกเฉพาะ <strong>Top N</strong> (ตามค่า Grid) เข้ามาเทรด</p></div></div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // ==========================================
        // UI HELPERS
        // ==========================================
        function toggleModal(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'flex')? 'none' : 'flex'; }
        
        function setTab(tabName) {
            ['chart', 'landscape', 'dist', 'monte', 'logs'].forEach(t => {
                document.getElementById('panel-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('tab-active');
                document.getElementById('tab-' + t).classList.add('tab-inactive');
            });
            document.getElementById('panel-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            document.getElementById('tab-' + tabName).classList.remove('tab-inactive');
            if(tabName === 'landscape') Plotly.Plots.resize('landscapeDiv');
            if(tabName === 'monte') Plotly.Plots.resize('monteDiv');
        }

        const log = (msg) => {
            const box = document.getElementById('statusBox');
            box.innerHTML = `<div>> ${msg}</div>` + box.innerHTML;
        };

        // ==========================================
        // CONFIG & STATE
        // ==========================================
        const QUOTE = "USDT";
        const TIMEFRAME = "1d";
        const LIMIT = 1000;
        const STRATEGIES = ['Equal', 'Rank', 'Top3', 'Top50Rank', 'MomWeight', 'InvVol', 'AAA'];
        
        let marketData = {}; 
        let alignedData = []; 
        let alignedReturns = []; 
        let candidatePool = [];
        let benchmarkData = [];
        let benchMetrics = {};
        
        let simulationResults = [];
        let selectedResultIndex = -1;
        
        let chartInstance = null;
        let ddChartInstance = null;
        let distChartInstance = null;
        let currentLogs = [];
        let currentLogPage = 1;
        const LOGS_PER_PAGE = 50; 

        // ==========================================
        // DATA INGESTION
        // ==========================================
        
        async function autoScanMarket() {
            const btn = document.getElementById('btnScan');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
            btn.disabled = true;
            log("Connecting to Binance Global Ticker...");

            try {
                // Fetch 24hr ticker for ALL symbols
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();

                // Filter logic
                const ignore = ['USDC', 'FDUSD', 'TUSD', 'BUSD', 'USDP', 'DAI', 'EUR', 'GBP', 'UP', 'DOWN', 'BEAR', 'BULL'];
                
                const candidates = data.filter(t => {
                    const sym = t.symbol;
                    // Must end with USDT
                    if (!sym.endsWith(QUOTE)) return false;
                    const base = sym.replace(QUOTE, '');
                    // Filter Stables & Leverage tokens
                    if (ignore.some(x => base.includes(x))) return false;
                    return true;
                });

                // Sort by Quote Volume (Dollar Volume) Descending
                candidates.sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));

                // Take Top 50
                const top50 = candidates.slice(0, 50).map(t => t.symbol.replace(QUOTE, ''));
                
                // Update UI
                const textArea = document.getElementById('universeInput');
                textArea.value = top50.join(',');
                
                log(`<span class="text-green-400">Success! Found ${top50.length} liquid pairs.</span>`);

            } catch(e) {
                log(`<span class="text-red-400">Scan Failed: ${e.message}</span> (Try CORS extension or Mock mode)`);
                // Fallback Mock
                document.getElementById('universeInput').value = "BTC,ETH,BNB,SOL,XRP,ADA,DOGE,DOT,AVAX,LINK,MATIC,TRX,SHIB,LTC,UNI";
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Mock data now includes Volume
        function generateMockData(symbol, days=1000) {
            let records = [];
            const hash = symbol.split('').reduce((a,b)=>a+b.charCodeAt(0),0);
            let price = 50 + (hash % 900); 
            let date = new Date();
            date.setDate(date.getDate() - days);

            const volNoise = 1000000 + (hash % 5000000);
            const drift = 0.0006; 

            for(let i=0; i<days; i++) {
                const u1 = Math.random();
                const u2 = Math.random();
                const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                const move = drift + (0.02 * z);
                price = price * Math.exp(move);
                
                const volume = volNoise * (0.5 + Math.random()) * (1 + Math.abs(move)*10);

                records.push({
                    time: date.getTime(),
                    close: price,
                    volume: volume
                });
                date.setDate(date.getDate() + 1);
            }
            return records;
        }

        async function fetchBinanceData(symbol) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 1500); 
                const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}${QUOTE}&interval=${TIMEFRAME}&limit=${LIMIT}`;
                const res = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if(!res.ok) throw new Error("API status " + res.status);
                
                const data = await res.json();
                return data.map(d => ({ 
                    time: d[0], 
                    close: parseFloat(d[4]),
                    volume: parseFloat(d[5])
                })); 
            } catch (e) {
                // If API fails, log only once per batch to avoid spam, but still return mock
                // log(`<span class="text-yellow-500">API Blocked (${symbol}). Mocking...</span>`);
                return generateMockData(symbol);
            }
        }

        // --- OPTIMIZED ALIGNMENT (HASH MAP) ---
        function alignDataMatrix(rawMap, symbols) {
            let allDates = new Set();
            symbols.forEach(s => { if(rawMap[s]) rawMap[s].forEach(p => allDates.add(p.time)); });
            const sortedDates = Array.from(allDates).sort((a,b) => a - b);
            
            // Build Hash Map for O(1) lookup
            // fastMap[symbol][time] = {close, volume}
            const fastMap = {};
            symbols.forEach(s => {
                fastMap[s] = {};
                if(rawMap[s]) {
                    rawMap[s].forEach(p => {
                        fastMap[s][p.time] = { c: p.close, v: p.volume };
                    });
                }
            });

            const matrix = [];
            const lastVals = {}; 
            symbols.forEach(s => lastVals[s] = null);

            sortedDates.forEach(t => {
                const row = { time: t };
                let complete = true;
                symbols.forEach(s => {
                    // O(1) Lookup
                    let pt = fastMap[s][t];
                    
                    if(pt) lastVals[s] = pt;
                    
                    if(lastVals[s]) {
                        row[`${s}_c`] = lastVals[s].c;
                        row[`${s}_v`] = lastVals[s].v;
                    } else {
                        complete = false;
                    }
                });
                if(complete) matrix.push(row);
            });
            return matrix;
        }

        function precalcDollarVolume(matrix, symbols) {
            for(let i=0; i<matrix.length; i++) {
                symbols.forEach(s => {
                    const price = matrix[i][`${s}_c`];
                    const vol = matrix[i][`${s}_v`];
                    const dv = price * vol;
                    matrix[i][`${s}_dv`] = dv;

                    // Rolling 30D Avg (Optimized loop)
                    let sum = 0, count = 0;
                    // Simple window sum
                    const win = 30;
                    if(i >= win - 1) {
                        for(let k=0; k<win; k++) sum += matrix[i-k][`${s}_dv`];
                        count = win;
                    } else {
                        // Startup period
                        for(let k=0; k<=i; k++) sum += matrix[i-k][`${s}_dv`];
                        count = i + 1;
                    }
                    matrix[i][`${s}_dv30`] = count>0 ? sum/count : dv;
                });
            }
        }

        function computeReturns(matrix, assets) {
            const returns = [];
            for(let i=0; i<matrix.length-1; i++) {
                const row = { time: matrix[i].time };
                assets.forEach(a => { 
                    row[a] = (matrix[i+1][`${a}_c`] - matrix[i][`${a}_c`]) / matrix[i][`${a}_c`]; 
                });
                returns.push(row);
            }
            return returns;
        }

        // --- DYNAMIC UNIVERSE ---
        function getActiveUniverse(dateIdx, size, pool) {
            const row = alignedData[dateIdx];
            const scored = pool.map(s => ({
                symbol: s,
                liq: row[`${s}_dv30`] || 0
            }));
            scored.sort((a,b) => b.liq - a.liq);
            return scored.slice(0, size).map(x => x.symbol);
        }

        // --- STRATEGY WEIGHTS ---
        function getWeights(strategy, universe, dateIdx, lookback) {
            let weights = {};
            universe.forEach(a => weights[a] = 0);
            
            const currentPrice = (s) => alignedData[dateIdx][`${s}_c`];
            const prevPrice = (s) => alignedData[dateIdx-lookback][`${s}_c`];
            
            const signals = universe.map(a => ({ 
                asset: a, 
                mom: (currentPrice(a) / prevPrice(a)) - 1, 
                vol: 0 
            }));

            if(["InvVol", "AAA"].includes(strategy)) {
                universe.forEach((a, idx) => {
                    // Optimization: calc mean/std only if needed
                    const rSlice = [];
                    for(let k=0; k<lookback; k++) {
                        if(dateIdx-k > 0) rSlice.push(alignedReturns[dateIdx-1-k][a]);
                    }
                    if(rSlice.length > 0) {
                        const mean = rSlice.reduce((s,v)=>s+v,0)/rSlice.length;
                        const variance = rSlice.reduce((s,v)=>s+Math.pow(v-mean,2),0)/rSlice.length;
                        signals[idx].vol = Math.sqrt(variance) || 0.01;
                    } else {
                        signals[idx].vol = 0.01;
                    }
                });
            }
            
            signals.sort((a,b) => b.mom - a.mom);
            const n = universe.length;

            if(strategy === "Equal") universe.forEach(a => weights[a] = 1/n);
            else if(strategy === "Rank") { const S = n*(n+1)/2; signals.forEach((s,i) => weights[s.asset] = (n-i)/S); }
            else if(strategy === "Top3") signals.slice(0,3).forEach(s => weights[s.asset] = 1/3);
            else if(strategy === "Top50Rank") { const k = Math.ceil(n/2); const S = k*(k+1)/2; signals.slice(0,k).forEach((s,i) => weights[s.asset] = (k-i)/S); }
            else if(strategy === "MomWeight") {
                const pos = signals.filter(s=>s.mom>0);
                const sumMom = pos.reduce((sum, s) => sum + s.mom, 0);
                if(pos.length > 0 && sumMom > 0) pos.forEach(s => weights[s.asset] = s.mom / sumMom);
            }
            else if(strategy === "InvVol") { let sum=0; signals.forEach(s=>{sum+=1/s.vol}); signals.forEach(s=>weights[s.asset]=(1/s.vol)/sum); }
            else if(strategy === "AAA") { let pos = signals.filter(s=>s.mom>0); if(pos.length===0) pos=signals.slice(0,3); let sum=0; pos.forEach(s=>{sum+=1/s.vol}); pos.forEach(s=>weights[s.asset]=(1/s.vol)/sum); }
            return weights;
        }

        // --- BACKTEST ---
        function runBacktest(strategy, lb, rb, univSize, univRebalDays, initialCapital, feeRate, verbose=false) {
            const startIdx = Math.max(lb, 30) + 1; 
            let nav = initialCapital;
            
            let currentUniverse = getActiveUniverse(startIdx-1, univSize, candidatePool);
            let currentWeights = getWeights(strategy, currentUniverse, startIdx-1, lb);
            
            nav -= nav * 1.0 * feeRate; 

            let equityCurve = [];
            let logs = [];

            // Main Loop
            for(let t = startIdx-1; t < alignedReturns.length; t++) {
                const retRow = alignedReturns[t];
                let portRet = 0;
                
                currentUniverse.forEach(a => {
                    if(currentWeights[a]) portRet += currentWeights[a] * (retRow[a] || 0);
                });
                nav = nav * (1 + portRet);
                equityCurve.push({ time: alignedData[t+1].time, nav: nav });

                const dateIdx = t + 1;
                const simDay = dateIdx - (startIdx - 1);

                const isUnivRebal = simDay % univRebalDays === 0;
                const isStratRebal = simDay % rb === 0;

                if ((isUnivRebal || isStratRebal) && dateIdx < alignedData.length - 1) {
                    let newUniverse = currentUniverse;
                    
                    if(isUnivRebal) {
                        newUniverse = getActiveUniverse(dateIdx, univSize, candidatePool);
                    }

                    const newWeights = getWeights(strategy, newUniverse, dateIdx, lb);

                    let turnover = 0;
                    let diffs = [];
                    // Logs logic only if verbose
                    if(verbose) {
                        const allAssets = new Set([...currentUniverse, ...newUniverse]);
                        allAssets.forEach(a => {
                            const oldW = currentWeights[a] || 0;
                            const newW = newWeights[a] || 0;
                            const diff = newW - oldW;
                            turnover += Math.abs(diff);
                            if(Math.abs(diff) > 0.001) diffs.push({ asset: a, diff: diff });
                        });
                        
                        const fee = nav * turnover * feeRate;
                        nav -= fee;

                        if(diffs.length > 0) {
                            const dateStr = new Date(alignedData[dateIdx].time).toLocaleDateString();
                            let eventType = isUnivRebal ? "Univ.Update" : "Rebalance";
                            diffs.sort((a,b) => a.diff - b.diff);
                            const details = diffs.map(d => `<span class="${d.diff>0?'log-buy':'log-sell'}">${d.diff>0?'Buy':'Sell'} ${d.asset} ${(Math.abs(d.diff)*100).toFixed(0)}%</span>`).join(" ");
                            logs.push({ date: dateStr, type: eventType, details, fee, nav });
                        }
                    } else {
                        // Fast path calculation for grid
                        const allAssets = new Set([...currentUniverse, ...newUniverse]);
                        allAssets.forEach(a => {
                            turnover += Math.abs((newWeights[a]||0) - (currentWeights[a]||0));
                        });
                        nav -= nav * turnover * feeRate;
                    }

                    currentUniverse = newUniverse;
                    currentWeights = newWeights;
                }
            }
            return { curve: equityCurve, logs: logs.reverse() };
        }

        // --- METRICS ---
        function calcMetrics(curve) {
            if(curve.length < 60) return null;
            const vals = curve.map(e => e.nav);
            const cagr = (Math.pow(vals[vals.length-1]/vals[0], 365/vals.length) - 1) * 100;
            
            let peak = vals[0], maxDD = 0;
            vals.forEach(v => { if(v>peak) peak=v; const d=(v-peak)/peak; if(d<maxDD) maxDD=d; });

            const rollPeriod = 30;
            const rollRets = [];
            for(let i=rollPeriod; i<vals.length; i++) {
                rollRets.push( (vals[i] - vals[i-rollPeriod])/vals[i-rollPeriod] );
            }
            const avgRoll = rollRets.reduce((a,b)=>a+b,0)/rollRets.length;
            const stdRoll = Math.sqrt(rollRets.reduce((a,b)=>a+Math.pow(b-avgRoll,2),0)/(rollRets.length-1));
            const rollSharpe = stdRoll>0 ? (avgRoll/stdRoll)*Math.sqrt(12) : 0;
            const win30d = (rollRets.filter(r=>r>0).length / rollRets.length) * 100;

            const rets = [];
            for(let i=1; i<vals.length; i++) rets.push((vals[i]-vals[i-1])/vals[i-1]);
            const stdDay = Math.sqrt(rets.reduce((a,b)=>a+Math.pow(b-(rets.reduce((x,y)=>x+y,0)/rets.length),2),0)/(rets.length-1));
            const annVol = stdDay * Math.sqrt(365) * 100;

            return { CAGR: cagr, MaxDD: maxDD*100, Sharpe: rollSharpe, Win30d: win30d, Vol: annVol, RollSharpe: rollSharpe };
        }

        function calculateRobustness(results) {
            results.forEach(r => {
                r.RobustScore = r.Sharpe * 0.7 + (r.Win30d/100) * 0.3; 
            });
        }

        // --- PIPELINE ---
        async function runPipeline() {
            const btn = document.getElementById('fetchBtn');
            let poolInput = document.getElementById('universeInput').value.split(',').map(s=>s.trim().toUpperCase()).filter(s=>s!=='');
            const benchSym = document.getElementById('benchmarkInput').value.trim().toUpperCase();
            
            // Auto-Fill if empty
            if(poolInput.length < 5) {
                log("Pool is empty/small. Auto-filling with default majors...");
                poolInput = "BTC,ETH,BNB,SOL,XRP,ADA,DOGE,DOT,AVAX,LINK,MATIC,TRX,SHIB,LTC,UNI,ATOM,XLM,ETC,FIL,NEAR".split(',');
                document.getElementById('universeInput').value = poolInput.join(',');
            }

            try {
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Processing Liquidity...';
                document.getElementById('statusBox').innerHTML = "";

                log("Step 1: Fetching Candidate Pool Data...");
                marketData = {};
                const allSyms = [...new Set([...poolInput, benchSym])];
                
                // Fetch in batches to prevent network congestion
                const batchSize = 10;
                for(let i=0; i<allSyms.length; i+=batchSize) {
                    const batch = allSyms.slice(i, i+batchSize);
                    await Promise.all(batch.map(async s => {
                        const d = await fetchBinanceData(s);
                        if(d && d.length>100) marketData[s] = d;
                    }));
                }
                
                candidatePool = poolInput.filter(s => marketData[s] && marketData[s].length > 0);
                if(candidatePool.length < 5) throw new Error("Not enough valid data (Network/CORS issue?)");

                log("Step 2: Calculating Dollar Volume & Alignment...");
                alignedData = alignDataMatrix(marketData, candidatePool);
                precalcDollarVolume(alignedData, candidatePool); 
                alignedReturns = computeReturns(alignedData, candidatePool);

                // Benchmark Calculation
                const benchRaw = alignDataMatrix(marketData, [benchSym]);
                const capital = parseFloat(document.getElementById('capital').value);
                const bCurve = benchRaw.map(x => ({ time: x.time, nav: (x[`${benchSym}_c`] / benchRaw[0][`${benchSym}_c`]) * capital }));
                benchMetrics = calcMetrics(bCurve);
                benchmarkData = bCurve; // STORE GLOBAL for Chart Re-base

                // Grid Params
                const uS = parseInt(document.getElementById('univStart').value), uE = parseInt(document.getElementById('univEnd').value), uStep = parseInt(document.getElementById('univStep').value);
                const uRebal = parseInt(document.getElementById('univRebalDays').value);
                const lbS=parseInt(document.getElementById('lbStart').value), lbE=parseInt(document.getElementById('lbEnd').value), lbStep=parseInt(document.getElementById('lbStep').value);
                const rbS=parseInt(document.getElementById('rbStart').value), rbE=parseInt(document.getElementById('rbEnd').value), rbStep=parseInt(document.getElementById('rbStep').value);
                const fee = parseFloat(document.getElementById('fee').value)/100;

                const tasks = [];
                for(let u=uS; u<=uE; u+=uStep) {
                    STRATEGIES.forEach(s => {
                        for(let lb=lbS; lb<=lbE; lb+=lbStep) {
                            for(let rb=rbS; rb<=rbE; rb+=rbStep) {
                                tasks.push({s, lb, rb, u});
                            }
                        }
                    });
                }

                log(`Step 3: Running ${tasks.length} Simulations...`);
                simulationResults = [];
                let completed = 0, CHUNK = 20;

                function process() {
                    try {
                        const end = Math.min(completed+CHUNK, tasks.length);
                        for(let i=completed; i<end; i++) {
                            const t = tasks[i];
                            const actualU = Math.min(t.u, candidatePool.length);
                            const res = runBacktest(t.s, t.lb, t.rb, actualU, uRebal, capital, fee, false);
                            const m = calcMetrics(res.curve);
                            if(m) simulationResults.push({...t, ...m, curve: res.curve, u: actualU});
                        }
                        completed = end;
                        document.getElementById('progressBar').style.width = `${(completed/tasks.length)*100}%`;
                        document.getElementById('simCount').innerText = `${completed}/${tasks.length}`;
                        
                        if(completed < tasks.length) setTimeout(process, 0);
                        else finish();
                    } catch(err) {
                        console.error(err);
                        alert("Simulation Error: " + err.message);
                        btn.disabled = false;
                        btn.innerHTML = 'Run Liquid Grid';
                    }
                }
                setTimeout(process, 50);

            } catch(e) {
                console.error(e);
                alert("Critical Error: " + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Run Liquid Grid';
            }
        }

        function finish() {
            log("Finalizing...");
            calculateRobustness(simulationResults);
            simulationResults.sort((a,b) => b.Sharpe - a.Sharpe);
            
            document.getElementById('fetchBtn').disabled = false;
            document.getElementById('fetchBtn').innerHTML = '<i class="fas fa-play"></i> Run Liquid Grid';
            log("Simulation Complete.");
            filterResults();
            if(simulationResults.length > 0) viewResult(0);
        }

        function filterResults() {
            const strat = document.getElementById('strategyFilter').value;
            const sortM = document.getElementById('sortMetric').value;
            let filtered = strat === "ALL"? simulationResults : simulationResults.filter(r => r.s === strat);
            
            if(sortM === 'MaxDD') filtered.sort((a,b) => a.MaxDD - b.MaxDD);
            else filtered.sort((a,b) => b[sortM] - a[sortM]);

            const top = filtered.slice(0, 100);
            const tbody = document.getElementById('resultsBody');

            tbody.innerHTML = top.map((r,i) => {
                return `
                <tr class="hover:bg-gray-800 transition border-b border-gray-800 cursor-pointer" onclick="viewResult(${simulationResults.indexOf(r)})">
                    <td class="p-3 text-gray-500 font-mono">#${i+1}</td>
                    <td class="p-3 font-bold text-blue-400">${r.s}</td>
                    <td class="p-3 text-center font-bold text-purple-400">Top ${r.u}</td>
                    <td class="p-3 text-center text-gray-400">${r.lb} / ${r.rb}</td>
                    <td class="p-3 text-right ${r.CAGR>=0?'text-green-400':'text-red-400'}">${r.CAGR.toFixed(1)}%</td>
                    <td class="p-3 text-right font-bold text-yellow-500">${r.Sharpe.toFixed(2)}</td>
                    <td class="p-3 text-right text-blue-400">${r.Win30d.toFixed(0)}%</td>
                    <td class="p-3 text-right text-green-400 font-bold">${r.RobustScore.toFixed(2)}</td>
                    <td class="p-3 text-right text-red-400">${r.MaxDD.toFixed(1)}%</td>
                    <td class="p-3 text-center"><button class="text-[9px] bg-gray-700 px-2 py-1 rounded">VIEW</button></td>
                </tr>`;
            }).join('');
        }
        
        function sortResults() { filterResults(); }

        function viewResult(idx) {
            selectedResultIndex = idx;
            const res = simulationResults[idx];
            if(!res) return;

            const uRebal = parseInt(document.getElementById('univRebalDays').value);
            const cap = parseFloat(document.getElementById('capital').value);
            const fee = parseFloat(document.getElementById('fee').value)/100;
            const detailed = runBacktest(res.s, res.lb, res.rb, res.u, uRebal, cap, fee, true);

            // Re-calculate Local Bench Metrics
            const startTime = detailed.curve[0].time;
            const benchMap = new Map(benchmarkData.map(b => [b.time, b.nav]));
            const startBenchVal = benchMap.get(startTime);
            let localBenchMetrics = { CAGR:0, Sharpe:0, Win30d:0, MaxDD:0, Vol:0 };
            
            if(startBenchVal) {
                const localBenchCurve = detailed.curve.map(p => {
                    const val = benchMap.get(p.time);
                    // Re-base logic: (Current / Start) * InitialCapital
                    return { time: p.time, nav: val ? (val / startBenchVal) * cap : cap };
                });
                const m = calcMetrics(localBenchCurve);
                if(m) localBenchMetrics = m;
            }

            const kpi = document.getElementById('kpiBar');
            kpi.innerHTML = `
                <div class="metric-card"><div class="metric-val text-yellow-500">${res.Sharpe.toFixed(2)}</div><div class="metric-label">Sharpe</div><div class="bench-val">B: ${localBenchMetrics.Sharpe.toFixed(2)}</div></div>
                <div class="metric-card"><div class="metric-val ${res.Win30d>=50?'metric-pos':'metric-neg'}">${res.Win30d.toFixed(0)}%</div><div class="metric-label">Win30d</div><div class="bench-val">B: ${localBenchMetrics.Win30d.toFixed(0)}%</div></div>
                <div class="metric-card"><div class="metric-val ${res.CAGR>=0?'metric-pos':'metric-neg'}">${res.CAGR.toFixed(1)}%</div><div class="metric-label">CAGR</div><div class="bench-val">B: ${localBenchMetrics.CAGR.toFixed(1)}%</div></div>
                <div class="metric-card"><div class="metric-val metric-neg">${res.MaxDD.toFixed(1)}%</div><div class="metric-label">MaxDD</div><div class="bench-val">B: ${localBenchMetrics.MaxDD.toFixed(1)}%</div></div>
                <div class="metric-card"><div class="metric-val metric-vol">${res.Vol.toFixed(1)}%</div><div class="metric-label">Vol</div><div class="bench-val">B: ${localBenchMetrics.Vol.toFixed(1)}%</div></div>
                <div class="metric-card"><div class="metric-val text-purple-400">Top ${res.u}</div><div class="metric-label">Universe</div></div>
                <div class="metric-card"><div class="metric-val text-blue-400">${document.getElementById('univRebalDays').value}d</div><div class="metric-label">Update</div></div>
            `;
            document.getElementById('chartLabel').innerText = `${res.s} (Top ${res.u} Liq) | LB:${res.lb} RB:${res.rb} | R-Score: ${res.RobustScore.toFixed(2)}`;

            renderChart(detailed.curve, res.s);
            renderLandscape(res.s);
            renderDistribution();
            runMonteCarlo(res);

            currentLogs = detailed.logs;
            currentLogPage = 1;
            renderLogPage();
        }

        function renderChart(curve, stratName) {
            const ctx1 = document.getElementById('equityChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            const initialCapital = parseFloat(document.getElementById('capital').value);
            const benchMap = new Map(benchmarkData.map(b => [b.time, b.nav]));
            
            // Re-base Benchmark to Start of Chart
            const startStratsTime = curve[0].time;
            const startBenchVal = benchMap.get(startStratsTime);

            const benchData = curve.map(p => {
                const bVal = benchMap.get(p.time);
                if(!bVal || !startBenchVal) return null;
                // Normalize: (Val / StartVal) * Capital
                return (bVal / startBenchVal) * initialCapital;
            });
            
            chartInstance = new Chart(ctx1, { type: 'line', data: { labels: curve.map(p => new Date(p.time).toLocaleDateString()), datasets: [ { label: stratName, data: curve.map(p => p.nav), borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, tension: 0.1 }, { label: 'Benchmark (Re-based)', data: benchData, borderColor: '#60a5fa', borderWidth: 1, pointRadius: 0, tension: 0.1, borderDash: [5,5] } ] }, options: { responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' }, plugins: { legend: { display: true, labels: { color: '#9ca3af' } } }, scales: { x: { display: false }, y: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } } } } });
            
            const ctx2 = document.getElementById('drawdownChart').getContext('2d');
            if(ddChartInstance) ddChartInstance.destroy();
            let peak = curve[0].nav;
            const ddData = curve.map(p => { if(p.nav>peak) peak=p.nav; return ((p.nav-peak)/peak)*100; });
            ddChartInstance = new Chart(ctx2, { type: 'line', data: { labels: curve.map(p => new Date(p.time).toLocaleDateString()), datasets: [{ label: 'Drawdown', data: ddData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', borderWidth: 1, fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' }, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#374151' }, ticks: { color: '#ef4444' } } } } });
        }

        function renderLandscape(stratName) {
            if(!stratName) {
                if(selectedResultIndex >= 0 && simulationResults[selectedResultIndex]) {
                    stratName = simulationResults[selectedResultIndex].s;
                } else if(simulationResults.length > 0) {
                    stratName = simulationResults[0].s;
                } else {
                    return;
                }
            }

            const metric = document.getElementById('landscapeMetric').value;
            let targetU = parseInt(document.getElementById('univStart').value);
            if(selectedResultIndex >= 0 && simulationResults[selectedResultIndex]) {
                targetU = simulationResults[selectedResultIndex].u;
            } else if (simulationResults.length > 0) {
                targetU = simulationResults[0].u;
            }

            const subset = simulationResults.filter(r => r.s === stratName && r.u === targetU);
            if(subset.length === 0) return;

            const lbs = [...new Set(subset.map(r=>r.lb))].sort((a,b)=>a-b);
            const rbs = [...new Set(subset.map(r=>r.rb))].sort((a,b)=>a-b);
            const zData = rbs.map(r => lbs.map(l => { const f = subset.find(x => x.lb === l && x.rb === r); return f ? f[metric] : null; }));
            const data = [{ x: lbs, y: rbs, z: zData, type: 'surface', colorscale: 'Viridis' }];
            Plotly.newPlot('landscapeDiv', data, { title: { text: `${stratName} (Top ${targetU}) - ${metric}`, font: { color: '#d1d5db' } }, margin: { l:0,r:0,b:0,t:30 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', scene: { xaxis: {title:'Lookback', color:'#9ca3af'}, yaxis: {title:'Rebalance', color:'#9ca3af'}, zaxis: {title:metric, color:'#9ca3af'} } }, {displayModeBar: false});
        }

        function renderDistribution() {
            const metric = document.getElementById('distMetric').value;
            const values = simulationResults.map(r => r[metric]).filter(v => isFinite(v));
            if(values.length === 0) return;

            const mean = values.reduce((a,b)=>a+b,0)/values.length;
            const sd = Math.sqrt(values.reduce((a,b)=>a+Math.pow(b-mean,2),0)/values.length);
            const min = Math.min(...values), max = Math.max(...values);
            const bins = 35; const step = (max - min) / bins || 1; 
            const hist = new Array(bins).fill(0); const labels = [];
            values.forEach(v => { let idx = Math.floor((v-min)/step); if(idx >= bins) idx = bins - 1; hist[idx]++; });
            for(let i=0; i<bins; i++) labels.push((min + i*step).toFixed(2));
            const getIndex = (val) => Math.max(0, Math.min(bins - 1, (val - min) / step));
            const ctx = document.getElementById('distChart').getContext('2d');
            if(distChartInstance) distChartInstance.destroy();
            
            // Define annotations with 1SD, 2SD, 3SD
            const annotations = {
                box3SD: { type: 'box', xMin: getIndex(mean-3*sd), xMax: getIndex(mean+3*sd), backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 0, drawTime: 'beforeDatasetsDraw' }, // Red (Widest)
                box2SD: { type: 'box', xMin: getIndex(mean-2*sd), xMax: getIndex(mean+2*sd), backgroundColor: 'rgba(234, 179, 8, 0.15)', borderWidth: 0, drawTime: 'beforeDatasetsDraw' }, // Yellow
                box1SD: { type: 'box', xMin: getIndex(mean-sd), xMax: getIndex(mean+sd), backgroundColor: 'rgba(34, 197, 94, 0.2)', borderWidth: 0, drawTime: 'beforeDatasetsDraw' }, // Green (Narrowest)
                lineMean: { type: 'line', scaleID: 'x', value: getIndex(mean), borderColor: 'white', borderWidth: 2, borderDash: [5, 5], label: { content: 'Mean', display: true, position: 'start', color: 'rgba(255,255,255,0.7)', font: {size: 9}, yAdjust: -10 } }
            };

            distChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: { labels: labels, datasets: [{ label: 'Frequency', data: hist, backgroundColor: '#60a5fa', barPercentage: 1.0, categoryPercentage: 1.0 }] }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }, 
                        annotation: { annotations: annotations } 
                    }, 
                    scales: { 
                        x: { display: true, ticks: { color: '#9CA3AF', maxTicksLimit: 10, autoSkip: true } }, 
                        y: { display: false } 
                    } 
                } 
            });
        }

        function runMonteCarlo(res) {
            if(!res) return;
            const years = parseFloat(document.getElementById('monteYears').value) || 1;
            const mu = (res.CAGR/100)/365;
            const sigma = (res.Vol/100)/Math.sqrt(365);
            const sims = 100; const days = Math.floor(365 * years);
            const paths = []; const lastNav = res.curve[res.curve.length-1].nav;
            const endValues = [], simMaxDDs = [], simVols = [];
            for(let s=0; s<sims; s++) {
                let path = [lastNav], price = lastNav, peak = lastNav, maxDD = 0, rets = [];
                for(let d=0; d<days; d++) {
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                    const ret = (mu - 0.5*sigma*sigma) + sigma*z;
                    price = price * Math.exp(ret);
                    rets.push(ret); if(price > peak) peak = price; const dd = (price - peak) / peak; if(dd < maxDD) maxDD = dd; path.push(price);
                }
                endValues.push(price); simMaxDDs.push(maxDD); 
                const meanR = rets.reduce((a,b)=>a+b,0)/rets.length;
                const varR = rets.reduce((a,b)=>a+Math.pow(b-meanR,2),0)/(rets.length-1);
                simVols.push(Math.sqrt(varR)*Math.sqrt(365));
                paths.push({ y: path, type: 'scatter', mode: 'lines', line: {color: 'rgba(236, 72, 153, 0.05)', width: 1}, hoverinfo: 'none' });
            }
            endValues.sort((a,b)=>a-b); simMaxDDs.sort((a,b)=>a-b); simVols.sort((a,b)=>a-b);
            const medianEnd = endValues[Math.floor(sims/2)];
            const worst = endValues[Math.floor(sims*0.05)];
            const best = endValues[Math.floor(sims*0.95)];
            const expCAGR = (Math.pow(medianEnd/lastNav, 1/years)-1)*100;
            const medMaxDD = simMaxDDs[Math.floor(sims/2)] * 100;
            document.getElementById('monteStats').innerHTML = `<div class="flex gap-4 items-center"><div class="text-right"><div class="text-pink-400 font-bold text-xs">Exp. End</div><div class="font-mono text-sm font-bold">$${Math.round(medianEnd).toLocaleString()}</div><div class="text-[9px] text-gray-500">${(worst/1000).toFixed(1)}k - ${(best/1000).toFixed(1)}k</div></div><div class="h-6 w-px bg-gray-700"></div><div class="text-center"><div class="text-gray-400 text-[9px] uppercase">CAGR</div><div class="font-mono text-xs text-gray-200">${expCAGR.toFixed(1)}%</div></div><div class="text-center"><div class="text-gray-400 text-[9px] uppercase">Exp. MaxDD</div><div class="font-mono text-xs text-red-400">${medMaxDD.toFixed(1)}%</div></div></div>`;
            Plotly.newPlot('monteDiv', paths, { title: { text: `Monte Carlo Forecast (${days} Days)`, font: {color: '#d1d5db', size: 12} }, margin: { l:40, r:10, b:30, t:30 }, showlegend: false, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', xaxis: {title:'Days',color:'#9ca3af'}, yaxis: {title:'Equity',color:'#9ca3af'} }, {displayModeBar: false});
        }

        function renderLogPage() {
            const b = document.getElementById('logBody');
            const total = currentLogs.length;
            const totalPages = Math.ceil(total / LOGS_PER_PAGE) || 1;
            const start = (currentLogPage - 1) * LOGS_PER_PAGE;
            const end = start + LOGS_PER_PAGE;
            const slice = currentLogs.slice(start, end);
            document.getElementById('logMeta').innerText = `${total} Events`;
            document.getElementById('logPageNum').innerText = `${currentLogPage} / ${totalPages}`;
            document.getElementById('btnPrevLog').disabled = currentLogPage === 1;
            document.getElementById('btnNextLog').disabled = end >= total;
            b.innerHTML = slice.map(l => `<tr class="hover:bg-gray-800/50 border-b border-gray-800"><td class="text-xs">${l.date}</td><td class="font-bold ${l.type==='Univ.Update'?'text-purple-400':'text-blue-400'} text-xs">${l.type}</td><td class="text-xs leading-relaxed">${l.details}</td><td class="text-right text-red-400 text-xs">-${l.fee.toFixed(2)}</td><td class="text-right font-mono text-yellow-500 text-xs">${l.nav.toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>`).join('');
        }

        function changeLogPage(delta) { currentLogPage += delta; renderLogPage(); }
        function rerunMonte() { if(selectedResultIndex >= 0) runMonteCarlo(simulationResults[selectedResultIndex]); }
    </script>
</body>
</html>
